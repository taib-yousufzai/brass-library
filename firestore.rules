rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      // Temporary: Allow public access to bypass Auth/Network blocking
      allow read, write: if true;
    }
    
    // Helper function to get role from Custom Claims OR Firestore Document (fallback)
    function role() {
      return request.auth.token.role;
    }

    // Check if user is admin via Claims OR Firestore Doc
    function isAdmin() { 
      return request.auth.token.role == "admin" || 
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin") ||
             request.auth.token.email.matches(".*admin@gmail.com"); // Regex or simple check
    }
    
    function isSales() { return role() == "sales"; }
    function isDesigner() { return role() == "designer"; }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection
    match /users/{uid} {
      allow read, write: if true; // DEBUG: Allow all
      
      match /favorites/{favoriteId} {
        allow read, write: if true; // DEBUG: Allow all
      }
    }

    // Media collection
    match /media/{id} {
      allow read, write: if true; // DEBUG
    }
    
    // Quotations collection
    match /quotations/{id} {
      allow read, write: if true; // DEBUG
    }

    // Categories collection
    match /categories/{categoryId} {
      allow read, write: if true; // DEBUG
    }
    
    // Analytics collection
    match /analytics/{docId} {
      allow read, write: if true; // DEBUG
    }
  }
}